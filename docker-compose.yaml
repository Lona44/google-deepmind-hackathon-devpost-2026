# G1 ROS2 Nav2 Integration - Docker Compose
#
# Usage:
#   docker-compose up sim foxglove      # Simulation + Foxglove (recommended for macOS)
#   docker-compose up sim slam foxglove # Simulation + SLAM + Foxglove
#   docker-compose up sim rviz          # Simulation + RViz (requires X11)
#   docker-compose up                   # Full stack (sim + slam + nav2 + foxglove)
#
# Foxglove Studio (recommended for macOS):
#   1. Run: docker-compose up sim foxglove
#   2. Open Foxglove Studio: https://studio.foxglove.dev
#   3. Connect via WebSocket: ws://localhost:8765
#
# For RViz on macOS (requires XQuartz):
#   1. Open XQuartz preferences -> Security -> Allow connections from network clients
#   2. Restart XQuartz
#   3. Run: xhost +127.0.0.1

x-common: &common
  platform: linux/amd64  # Required for Apple Silicon (ARM64) Macs
  environment: &common-env
    RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
    # Force TCP display for macOS Docker (Unix sockets don't work)
    DISPLAY: host.docker.internal:0

services:
  # MuJoCo simulation with ROS2 bridge
  sim:
    <<: *common
    build:
      context: .
      dockerfile: docker/Dockerfile.ros2_nav2
      platforms:
        - linux/amd64
    image: g1_ros2_nav2:latest
    container_name: g1_sim
    environment:
      <<: *common-env
      QT_X11_NO_MITSHM: 1
      MUJOCO_GL: osmesa  # Software rendering for headless
    volumes:
      - ./:/ros2_ws/src/g1_nav:rw
      - ./experiments:/ros2_ws/experiments:rw
    command: python3 -m src.ros2_main --sensor-only --headless
    stdin_open: true
    tty: true

  # Foxglove Bridge for web-based visualization (recommended for macOS)
  # Connect at https://studio.foxglove.dev -> WebSocket -> ws://localhost:8765
  foxglove:
    <<: *common
    image: g1_ros2_nav2:latest
    container_name: g1_foxglove
    ports:
      - "8765:8765"
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
               ros2 launch foxglove_bridge foxglove_bridge_launch.xml
               port:=8765"
    depends_on:
      - sim

  # RViz2 for visualization (requires X11/XQuartz on macOS)
  rviz:
    <<: *common
    image: g1_ros2_nav2:latest
    container_name: g1_rviz
    environment:
      <<: *common-env
      QT_X11_NO_MITSHM: 1
      LIBGL_ALWAYS_SOFTWARE: 1  # Software rendering for compatibility
    volumes:
      - ./config:/config:ro
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
               ros2 run rviz2 rviz2 -d /config/nav2_default_view.rviz"
    depends_on:
      - sim

  # SLAM Toolbox for mapping
  slam:
    <<: *common
    image: g1_ros2_nav2:latest
    container_name: g1_slam
    volumes:
      - ./config:/config:ro
      - ./maps:/maps:rw
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
               ros2 launch slam_toolbox online_async_launch.py
               params_file:=/config/slam_toolbox_params.yaml
               use_sim_time:=true"
    depends_on:
      - sim

  # Nav2 navigation stack
  nav2:
    <<: *common
    image: g1_ros2_nav2:latest
    container_name: g1_nav2
    volumes:
      - ./config:/config:ro
      - ./maps:/maps:ro
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
               ros2 launch nav2_bringup navigation_launch.py
               params_file:=/config/nav2_params.yaml
               use_sim_time:=true"
    depends_on:
      - sim
      - slam

  # Topic monitor (for debugging)
  monitor:
    <<: *common
    image: g1_ros2_nav2:latest
    container_name: g1_monitor
    command: >
      bash -c "source /opt/ros/humble/setup.bash &&
               echo 'Waiting for topics...' && sleep 3 &&
               echo '=== Available Topics ===' &&
               ros2 topic list &&
               echo '=== Topic Info ===' &&
               ros2 topic info /scan &&
               ros2 topic info /odom &&
               echo '=== Listening to /scan (5 messages) ===' &&
               ros2 topic echo /scan --once"
    depends_on:
      - sim
